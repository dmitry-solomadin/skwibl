// Generated by CoffeeScript 1.4.0
(function() {

  $(function() {
    var RoomCanvas;
    RoomCanvas = (function() {

      function RoomCanvas() {}

      RoomCanvas.prototype.init = function() {
        this.initElements();
        this.initComments();
        return this.initThumbnails();
      };

      RoomCanvas.prototype.initElements = function() {
        var removeElementById, selectedCid;
        removeElementById = function(id) {
          var element, _i, _len, _ref, _results;
          _ref = paper.project.activeLayer.children;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            element = _ref[_i];
            if (element.id === id) {
              _results.push(element.remove());
            } else {
              _results.push(void 0);
            }
          }
          return _results;
        };
        selectedCid = this.getSelectedCanvasId();
        return this.forEachThumbInContext(function(cid) {
          var canvasElements, element, path, rawElement, _i, _j, _len, _len1, _ref, _results;
          canvasElements = [];
          _ref = $(".canvasElement" + cid);
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            rawElement = _ref[_i];
            canvasElements.push(JSON.parse($(rawElement).val()));
          }
          _results = [];
          for (_j = 0, _len1 = canvasElements.length; _j < _len1; _j++) {
            element = canvasElements[_j];
            path = room.socketHelper.createElementFromData(element);
            if (cid !== selectedCid) {
              removeElementById(path.id);
            }
            path.strokeColor = element.strokeColor;
            path.strokeWidth = element.strokeWidth;
            path.opacity = element.opacity;
            path.eligible = false;
            _results.push(room.history.add(path));
          }
          return _results;
        });
      };

      RoomCanvas.prototype.initComments = function() {
        var selectedCid;
        selectedCid = this.getSelectedCanvasId();
        return this.forEachThumbInContext(function(cid) {
          var canvasComments, comment, createdComment, rawComment, _i, _j, _len, _len1, _ref, _results;
          canvasComments = [];
          _ref = $(".canvasComment" + cid);
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            rawComment = _ref[_i];
            canvasComments.push(JSON.parse($(rawComment).val()));
          }
          _results = [];
          for (_j = 0, _len1 = canvasComments.length; _j < _len1; _j++) {
            comment = canvasComments[_j];
            createdComment = room.socketHelper.createCommentFromData(comment);
            if (cid !== selectedCid) {
              _results.push(room.comments.hideComment(createdComment));
            } else {
              _results.push(void 0);
            }
          }
          return _results;
        });
      };

      RoomCanvas.prototype.initThumbnails = function() {
        var callback, cid, selectedCid, thumb, _i, _len, _ref, _results,
          _this = this;
        selectedCid = this.getSelectedCanvasId();
        callback = function(img, canvasId) {
          var prevOpts;
          prevOpts = room.getOpts();
          room.setOpts(_this.findCanvasOptsById(canvasId));
          if (selectedCid === canvasId) {
            paper.projects[1].activate();
          } else {
            paper.projects[0].activate();
          }
          _this.updateThumb(canvasId);
          _this.clearCopyCanvas();
          _this.setImage(img);
          paper.projects[1].activate();
          return room.setOpts(prevOpts);
        };
        _ref = this.getThumbs();
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          thumb = _ref[_i];
          cid = $(thumb).data("cid");
          if (selectedCid === cid) {
            paper.projects[1].activate();
          } else {
            paper.projects[0].activate();
          }
          this.addImage($(thumb).data("fid"), (function(canvasId) {
            return function(img) {
              return callback(img, canvasId);
            };
          })(cid));
          _results.push(paper.projects[1].activate());
        }
        return _results;
      };

      RoomCanvas.prototype.forEachThumbInContext = function(fn) {
        var cid, opts, selectedCid, selectedOpts, thumb, _i, _len, _ref;
        selectedCid = this.getSelectedCanvasId();
        _ref = this.getThumbs();
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          thumb = _ref[_i];
          cid = $(thumb).data("cid");
          opts = this.findCanvasOptsById(cid);
          if (opts) {
            room.setOpts(opts);
          } else {
            room.initOpts(cid);
          }
          fn(cid);
        }
        selectedOpts = this.findCanvasOptsById(selectedCid);
        return room.setOpts(selectedOpts);
      };

      RoomCanvas.prototype.clear = function() {
        var element, _i, _len, _ref;
        room.history.add({
          type: "clear",
          tools: room.history.getSelectableTools(),
          eligible: true
        });
        _ref = opts.historytools.allHistory;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          element = _ref[_i];
          if (!element.type) {
            element.opacity = 0;
          }
          if (element.commentMin) {
            room.comments.hideComment(element.commentMin);
          }
        }
        room.items.unselect();
        room.redrawWithThumb();
        return room.socket.emit("eraseCanvas");
      };

      RoomCanvas.prototype.erase = function() {
        var element, _i, _len, _ref;
        _ref = opts.historytools.allHistory;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          element = _ref[_i];
          console.log(element);
          if (!element.type) {
            element.remove();
          }
          if (element.commentMin) {
            room.comments.hideComment(element.commentMin);
          }
        }
        return room.redraw();
      };

      RoomCanvas.prototype.clearCopyCanvas = function() {
        var child, _i, _len, _ref, _results;
        _ref = paper.projects[0].activeLayer.children;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          child = _ref[_i];
          _results.push(child.remove());
        }
        return _results;
      };

      RoomCanvas.prototype.restore = function() {
        var element, _i, _len, _ref, _results;
        _ref = opts.historytools.allHistory;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          element = _ref[_i];
          if (!element.type) {
            if (element.isImage) {
              paper.project.activeLayer.insertChild(0, element);
            } else {
              paper.project.activeLayer.addChild(element);
            }
          }
          if (element.commentMin) {
            _results.push(room.comments.showComment(element.commentMin));
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      };

      RoomCanvas.prototype.setScale = function(scale) {
        var commentMax, element, finalScale, transformMatrix, _i, _len, _ref;
        finalScale = scale / opts.currentScale;
        opts.currentScale = scale;
        transformMatrix = new Matrix(finalScale, 0, 0, finalScale, 0, 0);
        paper.project.activeLayer.transform(transformMatrix);
        _ref = opts.historytools.allHistory;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          element = _ref[_i];
          if (element.commentMin) {
            element.commentMin.css({
              top: element.commentMin.position().top * finalScale,
              left: element.commentMin.position().left * finalScale
            });
            commentMax = element.commentMin[0].$maximized;
            commentMax.css({
              top: commentMax.position().top * finalScale,
              left: commentMax.position().left * finalScale
            });
            room.comments.redrawArrow(element.commentMin);
          }
        }
        return room.redraw();
      };

      RoomCanvas.prototype.addScale = function() {
        return this.setScale(opts.currentScale + 0.1);
      };

      RoomCanvas.prototype.subtractScale = function() {
        return this.setScale(opts.currentScale - 0.1);
      };

      RoomCanvas.prototype.handleUpload = function(canvasId, fileId, emit) {
        var _this = this;
        if (opts.image) {
          this.addNewThumbAndSelect(canvasId);
        }
        return this.addImage(fileId, function(img) {
          _this.setImage(img);
          _this.updateSelectedThumb();
          if (emit) {
            return room.socket.emit("fileAdded", {
              canvasId: canvasId,
              fileId: fileId
            });
          }
        });
      };

      RoomCanvas.prototype.addImage = function(fileId, callback) {
        var activeProject, image;
        image = new Image();
        image.src = "/files/" + ($("#pid").val()) + "/" + fileId;
        activeProject = paper.project;
        return $(image).on("load", function() {
          var img;
          img = new Raster(image);
          img.isImage = true;
          activeProject.activeLayer.insertChild(0, img);
          img.size.width = image.width;
          img.size.height = image.height;
          img.position = paper.view.center;
          img.fileId = fileId;
          if (callback != null) {
            return callback(img);
          }
        });
      };

      RoomCanvas.prototype.setImage = function(img) {
        opts.image = img;
        return room.history.add(img);
      };

      RoomCanvas.prototype.addNewThumb = function(canvasId) {
        var thumb;
        thumb = $("<a href='#' data-cid='" + canvasId + "'><canvas width='80' height='60'></canvas></a>");
        return $("#canvasSelectDiv").append(thumb);
      };

      RoomCanvas.prototype.addNewThumbAndSelect = function(canvasId) {
        this.erase();
        room.initOpts(canvasId);
        this.addNewThumb(canvasId);
        $("#canvasSelectDiv a").removeClass("canvasSelected");
        return $("#canvasSelectDiv a:last").addClass("canvasSelected");
      };

      RoomCanvas.prototype.updateThumb = function(canvasId) {
        var canvas, cvh, cvw, i, shift, sy, th, thumb, thumbContext, transformMatrix, tw, _i;
        thumb = this.findThumbByCanvasId(canvasId).find("canvas");
        thumbContext = thumb[0].getContext('2d');
        canvas = paper.project.view.element;
        cvw = $(canvas).width();
        cvh = $(canvas).height();
        tw = $(thumb).width();
        th = $(thumb).height();
        sy = th / cvh;
        transformMatrix = new Matrix(sy / opts.currentScale, 0, 0, sy / opts.currentScale, 0, 0);
        paper.project.activeLayer.transform(transformMatrix);
        room.redraw();
        shift = -((sy * cvw) - tw) / 2;
        thumbContext.clearRect(0, 0, tw, th);
        for (i = _i = 0; _i <= 5; i = ++_i) {
          thumbContext.drawImage(canvas, shift, 0);
        }
        transformMatrix = new Matrix(opts.currentScale / sy, 0, 0, opts.currentScale / sy, 0, 0);
        paper.project.activeLayer.transform(transformMatrix);
        return room.redraw();
      };

      RoomCanvas.prototype.updateSelectedThumb = function() {
        return this.updateThumb(this.getSelectedCanvasId());
      };

      RoomCanvas.prototype.getSelectedCanvasId = function() {
        return this.getSelected().data("cid");
      };

      RoomCanvas.prototype.getSelected = function() {
        return $(".canvasSelected");
      };

      RoomCanvas.prototype.getThumbs = function() {
        return $("#canvasSelectDiv a");
      };

      RoomCanvas.prototype.findThumbByCanvasId = function(canvasId) {
        return $("#canvasSelectDiv a[data-cid='" + canvasId + "']");
      };

      RoomCanvas.prototype.selectThumb = function(anchor, emit) {
        var canvasOpts, cid;
        if ($(anchor).hasClass("canvasSelected")) {
          return;
        }
        $("#canvasSelectDiv a").removeClass("canvasSelected");
        cid = $(anchor).data("cid");
        canvasOpts = this.findCanvasOptsById(cid);
        if (!canvasOpts) {
          alert("No canvas opts by given canvasId=" + cid);
        }
        this.erase();
        room.setOpts(canvasOpts);
        this.restore();
        $(anchor).addClass("canvasSelected");
        if (emit) {
          room.socket.emit("switchCanvas", cid);
        }
        return room.redraw();
      };

      RoomCanvas.prototype.findCanvasOptsById = function(canvasId) {
        var savedOpt, _i, _len, _ref;
        _ref = room.savedOpts;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          savedOpt = _ref[_i];
          if (savedOpt.canvasId === canvasId) {
            return savedOpt;
          }
        }
        return null;
      };

      return RoomCanvas;

    })();
    return App.room.canvas = new RoomCanvas;
  });

}).call(this);
