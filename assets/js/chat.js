// Generated by CoffeeScript 1.4.0
(function() {

  $(function() {
    var Chat;
    if (!currentPage("projects/show")) {
      return;
    }
    Chat = (function() {

      function Chat() {
        this.users = [];
        this.initSockets();
      }

      Chat.prototype.fold = function(link) {
        $("#chat").animate({
          left: -305
        });
        $("#header-foldable").animate({
          width: 200
        });
        $("#canvasFooter").animate({
          paddingLeft: 0
        });
        $(".canvasFooterInner").animate({
          width: $(window).width()
        }, function() {
          return $(".canvasFooterInner").css({
            width: "100%"
          });
        });
        return $(link).attr("onclick", "App.chat.unfold(this); return false;").find("img").attr("src", "/images/room/unfold.png");
      };

      Chat.prototype.unfold = function(link) {
        $("#chat").animate({
          left: 0
        });
        $("#header-foldable").data("width", $("#header-foldable").width());
        $("#header-foldable").animate({
          width: 280
        });
        $("#canvasFooter").animate({
          paddingLeft: 300
        });
        $(".canvasFooterInner").animate({
          width: $(window).width() - 300
        }, function() {
          return $(".canvasFooterInner").css({
            width: "100%"
          });
        });
        return $(link).attr("onclick", "App.chat.fold(this); return false;").find("img").attr("src", "/images/room/fold.png");
      };

      Chat.prototype.getUserById = function(uid) {
        var user;
        user = $("#chatUser" + uid);
        return {
          id: uid,
          displayName: user.data("display-name")
        };
      };

      Chat.prototype.addMessage = function(uid, message) {
        var user;
        user = this.getUserById(uid);
        return $('#conversation-inner').append("<div><b>" + user.displayName + ":</b> " + message + "</div>");
      };

      Chat.prototype.addTechMessage = function(message) {
        return $('#conversation-inner').append("<div>" + message + "</div>");
      };

      Chat.prototype.changeUserStatus = function(uid, online) {
        var chatStatus;
        chatStatus = $("#chatUser" + uid).find(".chatUserStatus");
        if (online) {
          return chatStatus.addClass("chatUserOnline").removeClass("chatUserOffline");
        } else {
          return chatStatus.addClass("chatUserOffline").removeClass("chatUserOnline");
        }
      };

      Chat.prototype.initSockets = function() {
        var _this = this;
        this.chatIO = io.connect('/chat', window.copt);
        this.chatIO.on('message', function(data, cb) {
          return _this.addMessage(data.id, data.message.element.msg);
        });
        this.chatIO.on('enter', function(uid, cb) {
          var user;
          _this.changeUserStatus(uid, true);
          user = _this.getUserById(uid);
          return _this.addTechMessage("<i>" + user.displayName + " entered the project</i>");
        });
        this.chatIO.on('exit', function(uid, cb) {
          var user;
          _this.changeUserStatus(uid, false);
          user = _this.getUserById(uid);
          return _this.addTechMessage("<i>" + user.displayName + " leaved the project</i>");
        });
        return this.chatIO.on('onlineUsers', function(uids) {
          var uid, _i, _len, _results;
          _results = [];
          for (_i = 0, _len = uids.length; _i < _len; _i++) {
            uid = uids[_i];
            _results.push(_this.changeUserStatus(uid, true));
          }
          return _results;
        });
      };

      return Chat;

    })();
    $('#chatsend').click(function() {
      var chatMessage;
      chatMessage = {
        element: {
          msg: $('#chattext').val(),
          elementId: App.room.generateId()
        }
      };
      $('#chattext').val('').focus();
      if (chatMessage.element.msg !== '') {
        App.chat.addMessage($("#uid")[0].value, chatMessage.element.msg);
        return App.chat.chatIO.emit("message", chatMessage);
      }
    });
    $('#chattext').keypress(function(e) {
      if (e.which === 13) {
        $(this).blur();
        return $('#chatsend').focus().click();
      }
    });
    return App.chat = new Chat;
  });

}).call(this);
